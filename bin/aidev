#!/bin/bash

# ============================================================================
# AI Dev Superpowers V3 - CLI Principal
# ============================================================================
# Comando unificado 'aidev' para gestﾃ｣o de projetos com AI
# 
# Uso: aidev <comando> [opﾃｧﾃｵes]
# ============================================================================

set -euo pipefail

# Detecta diretﾃｳrio do script (resolve symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
AIDEV_BIN_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
AIDEV_ROOT_DIR="$(dirname "$AIDEV_BIN_DIR")"
AIDEV_LIB_DIR="$AIDEV_ROOT_DIR/lib"

# Carrega mﾃｳdulos essenciais
source "$AIDEV_LIB_DIR/loader.sh"
load_essential_modules
load_module "templates"
load_module "mcp"

# ============================================================================
# Subcomandos
# ============================================================================

# Subcomando: init
# Inicializa AI Dev em um projeto
cmd_init() {
    parse_args "$@"
    
    if ! validate_args; then
        exit 1
    fi
    
    # Seleﾃｧﾃ｣o de Idioma Interativa
    if [ "${AIDEV_INTERACTIVE:-true}" = "true" ] && [ -z "${CLI_LANGUAGE:-}" ]; then
        echo -n "$(_ "select_lang")"
        read -r selected_lang
        case "$selected_lang" in
            en|EN) CLI_LANGUAGE="en" ;;
            pt|PT|pt-BR|PT-BR) CLI_LANGUAGE="pt-BR" ;;
            *) CLI_LANGUAGE="pt-BR" ;; # Default
        esac
    fi
    set_language "${CLI_LANGUAGE:-pt-BR}"

    print_header "AI Dev Superpowers"
    print_mode "$CLI_MODE" "$(_ "init_header") $install_path"
    
    # Auto-detecﾃｧﾃ｣o de stack
    if [ "$CLI_AUTO_DETECT" = "true" ]; then
        CLI_STACK=$(detect_stack "$install_path")
        print_info "Stack detectada: $CLI_STACK"
    fi
    
    # Auto-detecﾃｧﾃ｣o de plataforma
    if [ "$CLI_PLATFORM" = "auto" ]; then
        CLI_PLATFORM=$(detect_platform)
        print_info "Plataforma detectada: $CLI_PLATFORM"
    fi
    
    # Mostra configuraﾃｧﾃ｣o
    if [ "${AIDEV_DEBUG:-false}" = "true" ]; then
        show_config_summary
    fi
    
    # Dry run apenas mostra o que seria feito
    if [ "$AIDEV_DRY_RUN" = "true" ]; then
        print_info "[DRY-RUN] Simulando instalaﾃｧﾃ｣o..."
    fi
    
    # Reseta contadores
    reset_counters
    
    # Cria estrutura base
    print_step "$(_ "step_structure")"
    create_base_structure "$install_path"
    
    # Instala agentes
    print_step "$(_ "step_agents")"
    install_agents "$install_path"
    
    # Instala skills
    print_step "$(_ "step_skills")"
    install_skills "$install_path"
    
    # Instala rules
    print_step "$(_ "step_rules")"
    install_rules "$install_path" "$CLI_STACK"
    
    # Configura plataforma
    if [ "$CLI_NO_MCP" != "true" ]; then
        print_step "$(_ "step_mcp")"
        configure_mcp "$install_path" "$CLI_PLATFORM"
    fi

    # Instala instruﾃｧﾃｵes de ativaﾃｧﾃ｣o para a plataforma
    print_step "$(_ "step_platform")"
    install_platform_instructions "$install_path" "$CLI_PLATFORM"

    # Configura segredos (interativo)
    if [ "$CLI_NO_MCP" != "true" ]; then
        print_step "$(_ "step_secrets")"
        setup_secrets "$install_path"
    fi

    # Configura gitignore
    print_step "$(_ "step_gitignore")"
    setup_gitignore "$install_path"

    # Persiste estado inicial
    export CLI_INSTALL_PATH="$install_path"
    set_state_value "current_fase" "3"
    set_state_value "current_sprint" "4"
    set_state_value "current_platform" "$CLI_PLATFORM"
    set_state_value "current_stack" "$CLI_STACK"
    set_state_value "language" "$CLI_LANGUAGE"
    set_state_value "initialized_at" "$(date -Iseconds)"

    # Sumﾃ｡rio final
    print_summary "$CLI_MODE" "$CLI_STACK"
    
    print_success "$(_ "init_success")"
}

# Subcomando: upgrade
# Atualiza instalaﾃｧﾃ｣o existente
cmd_upgrade() {
    parse_args "$@"

    local install_path="${CLI_INSTALL_PATH:-.}"
    install_path=$(cd "$install_path" 2>/dev/null && pwd || echo "$install_path")

    if ! has_aidev_installed "$install_path"; then
        print_error "AI Dev nﾃ｣o estﾃ｡ instalado neste diretﾃｳrio"
        print_info "Use 'aidev init' para instalar"
        exit 1
    fi

    print_header "AI Dev Superpowers"
    print_mode "upgrade" "Atualizando em $install_path"

    # Detecta stack e plataforma
    CLI_STACK=$(detect_stack "$install_path")
    local platform="${CLI_PLATFORM:-auto}"
    if [ "$platform" = "auto" ]; then
        platform=$(detect_platform)
    fi
    print_info "Stack: $CLI_STACK | Plataforma: $platform"

    # Backup antes de atualizar
    print_step "Criando backup..."
    local backup_dir="$install_path/.aidev/backups/$(date +%Y%m%d%H%M%S)"
    ensure_dir "$backup_dir"
    cp -r "$install_path/.aidev/agents" "$backup_dir/" 2>/dev/null || true
    cp -r "$install_path/.aidev/skills" "$backup_dir/" 2>/dev/null || true

    reset_counters
    AIDEV_FORCE=true

    # Reinstala componentes
    print_step "Atualizando agentes..."
    install_agents "$install_path"

    print_step "Atualizando skills..."
    install_skills "$install_path"

    # Atualiza instruﾃｧﾃｵes de plataforma
    print_step "Atualizando instruﾃｧﾃｵes de plataforma..."
    install_platform_instructions "$install_path" "$platform"

    print_summary "upgrade" "$CLI_STACK"
    print_success "Atualizaﾃｧﾃ｣o concluﾃｭda!"
    print_info "Backup salvo em: $backup_dir"
}

# Subcomando: add-skill
# Adiciona skill customizada
cmd_add_skill() {
    local skill_name="${1:-}"
    shift || true
    parse_args "$@"
    
    if [ -z "$skill_name" ]; then
        print_error "Nome da skill ﾃｩ obrigatﾃｳrio"
        echo "Uso: aidev add-skill <nome>"
        exit 1
    fi
    
    local install_path="${CLI_INSTALL_PATH:-.}"
    local skill_dir="$install_path/.aidev/skills/$skill_name"
    
    if [ -d "$skill_dir" ] && [ "$AIDEV_FORCE" != "true" ]; then
        print_warning "Skill '$skill_name' jﾃ｡ existe (use --force)"
        exit 1
    fi
    
    print_step "Criando skill '$skill_name'..."
    
    ensure_dir "$skill_dir"
    
    # Cria SKILL.md template
    cat > "$skill_dir/SKILL.md" << EOF
---
name: $skill_name
description: Descriﾃｧﾃ｣o da skill $skill_name
triggers:
  - "trigger1"
  - "trigger2"
globs:
  - "**/*.md"
---

# $skill_name Skill

## When to Use
[Descreva quando usar esta skill]

## Purpose
[Descreva o propﾃｳsito]

## Process
1. [Passo 1]
2. [Passo 2]
3. [Passo 3]

## Key Principles
- [Princﾃｭpio 1]
- [Princﾃｭpio 2]
EOF
    
    print_success "Skill '$skill_name' criada em $skill_dir"
    print_info "Edite o arquivo SKILL.md para customizar"
}

# Subcomando: add-rule
# Adiciona regra customizada
cmd_add_rule() {
    local rule_name="${1:-}"
    shift || true
    parse_args "$@"
    
    if [ -z "$rule_name" ]; then
        print_error "Nome da rule ﾃｩ obrigatﾃｳrio"
        echo "Uso: aidev add-rule <nome>"
        exit 1
    fi
    
    local install_path="${CLI_INSTALL_PATH:-.}"
    local rule_file="$install_path/.aidev/rules/${rule_name}.md"
    
    if [ -f "$rule_file" ] && [ "$AIDEV_FORCE" != "true" ]; then
        print_warning "Rule '$rule_name' jﾃ｡ existe (use --force)"
        exit 1
    fi
    
    print_step "Criando rule '$rule_name'..."
    
    ensure_dir "$(dirname "$rule_file")"
    
    cat > "$rule_file" << EOF
# $rule_name Rules

## Conventions
[Descreva as convenﾃｧﾃｵes]

## Patterns
[Descreva os patterns a seguir]

## Anti-Patterns
[Descreva o que evitar]

## Examples
\`\`\`
// Exemplo de cﾃｳdigo
\`\`\`
EOF
    
    print_success "Rule '$rule_name' criada: $rule_file"
}

# Subcomando: add-agent
# Adiciona agente customizado
cmd_add_agent() {
    local agent_name="${1:-}"
    shift || true
    parse_args "$@"
    
    if [ -z "$agent_name" ]; then
        print_error "Nome do agente ﾃｩ obrigatﾃｳrio"
        echo "Uso: aidev add-agent <nome>"
        exit 1
    fi
    
    local install_path="${CLI_INSTALL_PATH:-.}"
    local agent_file="$install_path/.aidev/agents/${agent_name}.md"
    
    if [ -f "$agent_file" ] && [ "$AIDEV_FORCE" != "true" ]; then
        print_warning "Agent '$agent_name' jﾃ｡ existe (use --force)"
        exit 1
    fi
    
    print_step "Criando agent '$agent_name'..."
    
    ensure_dir "$(dirname "$agent_file")"
    
    cat > "$agent_file" << EOF
# $agent_name Agent

## Role
[Descreva o papel deste agente]

## Responsibilities
- [Responsabilidade 1]
- [Responsabilidade 2]
- [Responsabilidade 3]

## Guidelines
- [Guideline 1]
- [Guideline 2]

## Tools
- [Tool 1]
- [Tool 2]
EOF
    
    print_success "Agent '$agent_name' criado: $agent_file"
}

# Subcomando: status
# Mostra status da instalaﾃｧﾃ｣o
cmd_status() {
    parse_args "$@"
    
    local install_path="${CLI_INSTALL_PATH:-.}"
    install_path=$(cd "$install_path" 2>/dev/null && pwd || echo "$install_path")
    
    print_header "AI Dev Superpowers"
    
    if ! has_aidev_installed "$install_path"; then
        print_warning "AI Dev nﾃ｣o estﾃ｡ instalado neste diretﾃｳrio"
        exit 0
    fi
    
    print_success "AI Dev instalado: $install_path/.aidev/"
    
    # Detecta contexto
    local stack=$(detect_stack "$install_path")
    local platform=$(detect_platform)
    local project_name=$(detect_project_name "$install_path")
    
    print_section "Contexto"
    echo "  Projeto:    $project_name"
    echo "  Stack:      $stack"
    echo "  Plataforma: $platform"
    
    # Progresso da Sessﾃ｣o (usa variﾃ｡veis globais sincronizadas em sync_session_state)
    echo "  Progresso:  Fase ${current_fase:-1} | Sprint ${current_sprint:-0}"
    echo "  Tarefa:     ${current_task:-Pendente}"
    
    if [ -n "${initialized_at:-}" ] && [ "$initialized_at" != "N/A" ]; then
        echo "  ﾃ嗟tima Ativ: $initialized_at"
    fi

    # Histﾃｳrico Git Recente
    if [ -d "$install_path/.git" ]; then
        print_section "Histﾃｳrico Recente (Git)"
        git -C "$install_path" log -n 3 --oneline --no-decorate --color=always | sed 's/^/  /'
    fi
    
    # Lista agentes
    print_section "Agentes Instalados"
    local agents_dir="$install_path/.aidev/agents"
    if [ -d "$agents_dir" ]; then
        local count=0
        for agent in "$agents_dir"/*.md; do
            if [ -f "$agent" ]; then
                echo "  窶｢ $(basename "$agent" .md)"
                ((count++)) || true
            fi
        done
        echo "  Total: $count agentes"
    else
        echo "  Nenhum agente instalado"
    fi
    
    # Lista skills
    print_section "Skills Instaladas"
    local skills_dir="$install_path/.aidev/skills"
    if [ -d "$skills_dir" ]; then
        local count=0
        for skill in "$skills_dir"/*/SKILL.md; do
            if [ -f "$skill" ]; then
                local skill_name=$(dirname "$skill")
                echo "  窶｢ $(basename "$skill_name")"
                ((count++)) || true
            fi
        done
        echo "  Total: $count skills"
    else
        echo "  Nenhuma skill instalada"
    fi
    
    # Lista rules
    print_section "Rules Instaladas"
    local rules_dir="$install_path/.aidev/rules"
    if [ -d "$rules_dir" ]; then
        local count=0
        for rule in "$rules_dir"/*.md; do
            if [ -f "$rule" ]; then
                echo "  窶｢ $(basename "$rule" .md)"
                ((count++)) || true
            fi
        done
        echo "  Total: $count rules"
    else
        echo "  Nenhuma rule instalada"
    fi
    
    echo ""
}

# Subcomando: doctor
# Diagnﾃｳstico da instalaﾃｧﾃ｣o e ambiente com sugestﾃｵes de reparo
cmd_doctor() {
    parse_args "$@"
    
    local install_path="${CLI_INSTALL_PATH:-.}"
    install_path=$(cd "$install_path" 2>/dev/null && pwd || echo "$install_path")
    
    print_header "AI Dev Doctor"
    
    local issues=0
    local warnings=0

    # 1. Dependﾃｪncias do Sistema
    print_section "Dependﾃｪncias do Sistema"
    local deps=("git" "jq" "bash" "sed" "grep")
    for dep in "${deps[@]}"; do
        if command -v "$dep" >/dev/null 2>&1; then
            print_success "$dep: $(command -v "$dep")"
        else
            if [ "$dep" == "jq" ]; then
                print_warning "$dep: Nﾃグ ENCONTRADO (usando fallback Bash)"
                ((warnings++)) || true
            else
                print_error "$dep: Nﾃグ ENCONTRADO"
                ((issues++)) || true
            fi
        fi
    done
    
    # 2. Verifica instalaﾃｧﾃ｣o
    print_section "Verificando Instalaﾃｧﾃ｣o"
    if has_aidev_installed "$install_path"; then
        print_success ".aidev/ existe"
        
        # Verifica diretﾃｳrios
        local dirs=("agents" "skills" "rules" "state")
        for dir in "${dirs[@]}"; do
            if [ -d "$install_path/.aidev/$dir" ]; then
                print_success ".aidev/$dir/ existe"
            else
                print_warning ".aidev/$dir/ nﾃ｣o encontrado"
                ((warnings++)) || true
            fi
        done
    else
        print_error ".aidev/ nﾃ｣o encontrado em $install_path"
        ((issues++)) || true
    fi
    
    # 3. Estado da Sessﾃ｣o
    print_section "Estado da Sessﾃ｣o"
    local state_file="$install_path/.aidev/state/session.json"
    if [ -f "$state_file" ]; then
        if command -v jq >/dev/null 2>&1 && ! jq . "$state_file" >/dev/null 2>&1; then
            print_error "Arquivo session.json corrompido"
            ((issues++)) || true
        else
            print_success "Arquivo session.json ﾃｭntegro"
        fi
    else
        print_info "session.json ainda nﾃ｣o inicializado"
    fi
    
    # 4. Segredos e Seguranﾃｧa
    print_section "Segredos e Seguranca"
    local env_file="$install_path/.env"
    if [ -f "$env_file" ]; then
        load_env "$env_file"
        if [ -n "${CONTEXT7_API_KEY:-}" ]; then
            print_success "Context7 API Key configurada"
        else
            print_warning "Context7 API Key ausente no .env"
            ((warnings++)) || true
        fi
        
        # Verifica se .env estﾃ｡ no gitignore
        if [ -f "$install_path/.gitignore" ]; then
            if grep -q "^\.env" "$install_path/.gitignore" || grep -q "/\.env" "$install_path/.gitignore"; then
                print_success ".env protegido no .gitignore"
            else
                print_error ".env Nﾃグ estﾃ｡ no .gitignore (RISCO DE EXPOSIﾃﾃグ)"
                ((issues++)) || true
            fi
        fi
    else
        print_info ".env nﾃ｣o encontrado (opcional, mas recomendado para MCP)"
    fi
    
    # 5. Contexto
    print_section "Contexto Detectado"
    local platform=$(detect_platform)
    local stack=$(detect_stack "$install_path")
    print_info "Plataforma: $platform"
    print_info "Stack:      $stack"

    # 5. Sugestﾃｵes de Reparo
    if [ $issues -gt 0 ] || [ $warnings -gt 0 ]; then
        print_section "Sugestﾃｵes de Reparo"
        if ! command -v jq >/dev/null 2>&1; then
            echo -e "  窶｢ ${YELLOW}Instalar jq:${NC} sudo apt install jq  (ou brew install jq)"
        fi
        if ! command -v git >/dev/null 2>&1; then
            echo -e "  窶｢ ${RED}Instalar git:${NC} sudo apt install git"
        fi
        if [ ! -d "$install_path/.aidev" ]; then
            echo -e "  窶｢ ${CYAN}Inicializar Projeto:${NC} aidev init"
        fi
        if [ -f "$install_path/.env" ] && [ -z "${CONTEXT7_API_KEY:-}" ]; then
            echo -e "  窶｢ ${YELLOW}Context7:${NC} Adicione CONTEXT7_API_KEY ao seu arquivo .env"
        fi
    fi

    echo ""
    if [ $issues -eq 0 ]; then
        if [ $warnings -eq 0 ]; then
            print_success "Tudo limpo! Seu ambiente estﾃ｡ saudﾃ｡vel."
        else
            print_info "Ambiente operacional, mas com $warnings avisos."
        fi
    else
        print_error "Encontrados $issues problemas crﾃｭticos. Verifique as mensagens acima."
    fi
    echo ""
}

# ============================================================================
# Funﾃｧﾃｵes de Instalaﾃｧﾃ｣o
# ============================================================================

# Cria estrutura base de diretﾃｳrios
create_base_structure() {
    local path="$1"
    
    ensure_dir "$path/.aidev"
    ensure_dir "$path/.aidev/agents"
    ensure_dir "$path/.aidev/skills"
    ensure_dir "$path/.aidev/rules"
    ensure_dir "$path/.aidev/state"
    ensure_dir "$path/.aidev/state/lessons"
    ensure_dir "$path/.aidev/analysis"
}

# Instala agentes a partir dos templates com suporte a overrides por plataforma
install_agents() {
    local path="$1"
    local agents_dir="$path/.aidev/agents"
    local platform_agents_dir="$AIDEV_ROOT_DIR/templates/platform/$CLI_PLATFORM/agents"
    
    # Exporta variﾃ｡veis para os templates
    export PROJECT_NAME=$(detect_project_name "$path")
    export STACK="$CLI_STACK"
    export PLATFORM="$CLI_PLATFORM"
    
    # Itera sobre os templates globais primeiro para garantir que todos os bﾃ｡sicos existam
    for template in "$AIDEV_ROOT_DIR/templates/agents"/*.md.tmpl; do
        if [ -f "$template" ]; then
            local name=$(basename "$template" .md.tmpl)
            local output="$agents_dir/${name}.md"
            
            # Verifica se existe override na plataforma
            local template_to_use="$template"
            if [ -n "$CLI_PLATFORM" ] && [ -f "$platform_agents_dir/${name}.md.tmpl" ]; then
                template_to_use="$platform_agents_dir/${name}.md.tmpl"
                print_debug "Usando override de plataforma para: $name"
            fi
            
            if should_write_file "$output"; then
                process_template "$template_to_use" "$output"
                print_debug "Instalado: $name (de $(basename "$(dirname "$template_to_use")"))"
            fi
        fi
    done
}

# Instala skills a partir dos templates
install_skills() {
    local path="$1"
    local skills_dir="$path/.aidev/skills"
    
    for skill_template_dir in "$AIDEV_ROOT_DIR/templates/skills"/*/; do
        if [ -d "$skill_template_dir" ]; then
            local skill_name=$(basename "$skill_template_dir")
            local output_dir="$skills_dir/$skill_name"
            
            ensure_dir "$output_dir"
            
            for template in "$skill_template_dir"/*.tmpl; do
                if [ -f "$template" ]; then
                    local name=$(basename "$template" .tmpl)
                    local output="$output_dir/$name"
                    
                    if should_write_file "$output"; then
                        process_template "$template" "$output"
                    fi
                fi
            done
        fi
    done
}

# Instala rules a partir dos templates
install_rules() {
    local path="$1"
    local stack="$2"
    local rules_dir="$path/.aidev/rules"
    
    # Sempre instala generic
    local generic_template="$AIDEV_ROOT_DIR/templates/rules/generic.md.tmpl"
    if [ -f "$generic_template" ]; then
        process_template "$generic_template" "$rules_dir/generic.md"
    fi
    
    # Instala rule especﾃｭfica da stack
    local stack_template="$AIDEV_ROOT_DIR/templates/rules/${stack}.md.tmpl"
    if [ -f "$stack_template" ]; then
        process_template "$stack_template" "$rules_dir/${stack}.md"
    fi
}

# Configura MCP
configure_mcp() {
    local path="$1"
    local platform="$2"

    # Carrega mﾃｳdulo MCP se nﾃ｣o carregado
    load_module "mcp" 2>/dev/null || true

    # Setup completo do MCP Engine
    setup_mcp_engine "$path" "$platform"
}

# Instala instruﾃｧﾃｵes de plataforma (lembrete de ativaﾃｧﾃ｣o)
install_platform_instructions() {
    local path="$1"
    local platform="$2"

    # Exporta variﾃ｡veis para templates
    export PROJECT_NAME=$(detect_project_name "$path")
    export STACK="$CLI_STACK"

    local templates_dir="$AIDEV_ROOT_DIR/templates/platform"

    # Sempre instala o arquivo genﾃｩrico AI_INSTRUCTIONS.md em .aidev/
    local generic_template="$templates_dir/AI_INSTRUCTIONS.md.tmpl"
    if [ -f "$generic_template" ]; then
        local output="$path/.aidev/AI_INSTRUCTIONS.md"
        if should_write_file "$output"; then
            process_template "$generic_template" "$output"
            print_debug "Instruﾃｧﾃｵes genﾃｩricas: AI_INSTRUCTIONS.md"
        fi
    fi

    # Instala arquivo especﾃｭfico da plataforma na raiz do projeto
    case "$platform" in
        "claude-code")
            local template="$templates_dir/CLAUDE.md.tmpl"
            local output="$path/CLAUDE.md"
            if [ -f "$template" ] && should_write_file "$output"; then
                process_template "$template" "$output"
                print_success "Criado: CLAUDE.md (lembrete de ativaﾃｧﾃ｣o)"
            fi
            ;;
        "cursor")
            local template="$templates_dir/cursorrules.tmpl"
            local output="$path/.cursorrules"
            if [ -f "$template" ] && should_write_file "$output"; then
                process_template "$template" "$output"
                print_success "Criado: .cursorrules (lembrete de ativaﾃｧﾃ｣o)"
            fi
            ;;
        "gemini")
            local template="$templates_dir/GEMINI.md.tmpl"
            local output="$path/GEMINI.md"
            if [ -f "$template" ] && should_write_file "$output"; then
                process_template "$template" "$output"
                print_success "Criado: GEMINI.md (lembrete de ativaﾃｧﾃ｣o)"
            fi
            ;;
        "aider")
            local template="$templates_dir/AIDER.md.tmpl"
            local output="$path/AIDER.md"
            if [ -f "$template" ] && should_write_file "$output"; then
                process_template "$template" "$output"
                print_success "Criado: AIDER.md (lembrete de ativaﾃｧﾃ｣o)"
            fi
            ;;
        *)
            # Para plataformas genﾃｩricas, cria um arquivo na raiz
            local template="$templates_dir/AI_INSTRUCTIONS.md.tmpl"
            local output="$path/AI_INSTRUCTIONS.md"
            if [ -f "$template" ] && should_write_file "$output"; then
                process_template "$template" "$output"
                print_success "Criado: AI_INSTRUCTIONS.md (lembrete de ativaﾃｧﾃ｣o)"
            fi
            ;;
    esac
}

# Adiciona .aidev/state ao .gitignore do projeto se existir
setup_gitignore() {
    local path="$1"
    local gitignore="$path/.gitignore"
    
    if [ -d "$path/.git" ] || [ -f "$gitignore" ]; then
        if [ ! -f "$gitignore" ]; then
            echo "# AI Dev Superpowers" > "$gitignore"
        fi
        
        if ! grep -q ".aidev/state/" "$gitignore"; then
            echo "" >> "$gitignore"
            echo "# AI Dev State (dynamic session data)" >> "$gitignore"
            echo ".aidev/state/" >> "$gitignore"
            echo ".env" >> "$gitignore"
            print_debug "Adicionado .aidev/state/ e .env ao .gitignore"
        fi
    fi
}

# Configura segredos interativamente
setup_secrets() {
    local path="$1"
    local env_file="$path/.env"
    
    # Carrega env existente se houver
    load_env "$env_file"
    
    # Context7 API Key
    if [ -z "$CONTEXT7_API_KEY" ]; then
        print_header "Configuracﾃ｣o de Segredos"
        print_info "O MCP Context7 requer uma API Key para funcionar."
        print_info "Crie uma em: https://context7.com/dashboard"
        echo -n "泊 Cole sua Context7 API Key (ou Enter para pular): "
        read -r key
        
        if [ -n "$key" ]; then
            set_env_value "CONTEXT7_API_KEY" "$key" "$env_file"
            print_success "Chave configurada com sucesso!"
        else
            print_warning "Chave nﾃ｣o configurada. O Context7 pode nﾃ｣o funcionar."
        fi
    fi
}

# ============================================================================
# Main
# ============================================================================

main() {
    local command="${1:-help}"
    # shift || true # Deixa o comando original para o parse_args identificar
    
    case "$command" in
        init)
            cmd_init "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        add-skill)
            cmd_add_skill "$@"
            ;;
        add-rule)
            cmd_add_rule "$@"
            ;;
        add-agent)
            cmd_add_agent "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        doctor)
            cmd_doctor "$@"
            ;;
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            show_version
            ;;
        *)
            print_error "Comando desconhecido: $command"
            echo ""
            echo "Use 'aidev --help' para ver comandos disponﾃｭveis"
            exit 1
            ;;
    esac
}

# Executa
main "$@"
